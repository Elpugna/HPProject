<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">


    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.8/dist/semantic.min.css">
    <script src="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.8/dist/semantic.min.js"></script>

    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.12.1/css/jquery.dataTables.css">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/fomantic-ui/2.8.8/semantic.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.12.1/css/dataTables.semanticui.min.css">


    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>

    <title>HP Project</title>
    <style>
        thead {
          font-variant: small-caps;
          font-weight: bold;
        }
        .entry{
            margin: 5px;
            box-shadow: 1px 1px 3px 1px black;
            padding: 1em;
            background-color: #FCFEFC;
        }
        .reviewData,.productData{
            display:flex;
            flex-wrap:wrap;
            justify-content: space-between;
        }
        .productData{
            flex-direction:row-reverse;
        }
        .reviewData div,.productData div{
            margin: 0 1em;
        }
        .reviewData div b, .productData div b {
          text-transform: capitalize;
          margin-right: 0.3rem;
        }
    </style>
    <script type="text/javascript">
        var dataTable = null
        var section = "customer"
        var columns = {
        customer:['id','name','product reviews'],
        product:['category','id','title','reviews'],
        review:[
              "id",
              "title",
              "rating",
              "date",
              "body",
              "customer",
              "product",
              "region",
              "helpful",
              "verified",
              "vine",
              "votes"]
        }

        function setTable(table){
            section=table
            $("#container").html(
                "<div><table id='table'><thead><tr>"+
                columns[table].map(x=>"<td>"+x+"</td>").join(" ")
                +"</tr></thead></table></div>"
                +"<button class='ui primary green icon button' onclick=\"$('#add"
                +_.capitalize(table)
                +"Modal').modal('show')\"><i class='add icon'></i></button>"
            )
            $("#status").text( "- Showing "+_.capitalize(table)+"s")
            loadTable(table,columns[table].map(x=>({data:x})))
        }
        function showProductReviews(id){
            fetch(baseUri+"product/"+id+"/reviews/all",
                {method:'GET',
                   headers: {
                    'Content-Type': 'application/json',
                  }
                }).then(x=>{
                    return x.json()
                }).then(data=>  {
                    console.log(data)
                    $(`#viewProductModal .content`).html(
                        data
                        .map(r=> `
                        <div class="entry"><h3>Review</h3>
                        <div class="reviewData">
                            ${_.toPairs(r).map(p=>"<div><b>"+p.join("</b>")+"</div>").join("<br>")}
                        </div>
                        </div>`)
                        .join("<hr>")
                    )
                });

        $(`#viewProductModal`).modal('show')
        }
        function showCustomerReviews(id){
            fetch(baseUri+"customer/"+id+"/reviews/all",
                {method:'GET',
                   headers: {
                    'Content-Type': 'application/json',
                  }
                }).then(x=>{
                    return x.json()
                }).then(data=>  {
                    console.log(data)
                    $(`#viewCustomerModal .content`).html(
                        data
                        .map(tuple=> `
                        <div class="entry"><h3>Product</h3>
                        <div class="productData">
                            ${_.toPairs(tuple[1]).map(p=>"<div><b>"+p.join("</b>")+"</div>").join("<br>")}
                        </div>
                        <details>
                        <summary><b>Review</b></summary>
                        <div class="reviewData">
                            ${_.toPairs(tuple[0]).map(p=>"<div><b>"+p.join("</b>")+"</div>").join("<br>")}
                        </div>
                        </details>
                        </div>`)
                        .join("<hr>")
                    )
                });

        $(`#viewCustomerModal`).modal('show')
        }

        async function responseHandler(x){
            console.log(x)
            if(x.status> 205){
                var t = await x.text()
                $('body')
                  .toast({
                    message: `<b>${x.statusText}:</b>${t}`
                  })
            }else{
                $('body')
                  .toast({
                    message: `<b>${x.statusText}!</b`
                  })
                    dataTable?.ajax.reload()
                    $(`#add${_.capitalize(section)}Modal`).modal('hide')
            }
        }
        const regex = /"(-?[0-9]+\.{0,1}[0-9]*)"/g
        function setupPost(endpoint){
            var form = document.querySelector(`#${endpoint}Form`)
            form.onsubmit = function(event){
                var formData = new FormData(form);
                var checkbox = $(`#${endpoint}Form`).find("input[type=checkbox]")
                $.each(checkbox, function(key, val) {
                    formData.append($(val).attr('name'), $(this).is(':checked'))
                })
                fetch(baseUri+endpoint,
                {
                   body: JSON.stringify(Object.fromEntries(formData)).replace(regex, '$1').replaceAll('"true"','true').replaceAll('"false"','false'),
                   method: 'POST',
                   headers: {
                    'Content-Type': 'application/json',
                  }
                }).then(responseHandler);

                return false;
            }
        }

        $( document ).ready(function() {
            setTable(section)
            setupPost("customer")
            setupPost("product")
            setupPost("review")
            $('#verifiedNew').checkbox()
            $('#vineNew').checkbox()
        });
        var baseUri= 'http://localhost:8080/api/'

        function buildPagedQuery(uri){
            return baseUri+uri
        }
        function loadTable(endpoint,format){
            dataTable = $('#table').DataTable( {
                serverSide: true,
                ajax: {
                    "url":buildPagedQuery(endpoint),
                    "type":'GET',
                    data:function(data){
                        var req = {}
                        req.page = data.start/data.length;
                        req.length= data.length
                        return  req;
                    },
                    dataFilter: function(data){
                        var json = jQuery.parseJSON( data );
                        if(section=="customer") json.data = json.data.map(c=> _.set(c,"product reviews",`<button class="ui tertiary button" onClick="showCustomerReviews('${c.id}')">View</button>`))
                        if(section=="product") json.data = json.data.map(c=> _.set(c,"reviews",`<button class="ui tertiary button" onClick="showProductReviews('${c.id}')">View</button>`))
                        json.recordsTotal = json.total;
                        json.recordsFiltered = json.total;
                        return JSON.stringify( json );
                    }
                },
                dataSrc: '',
                "sAjaxDataProp": "data",
                columns: format,
                "scrollY": "500px",
                "scrollCollapse": true,
                "searching":false,
                "ordering":false
            } );
        }
    </script>

</head>
<body>
<div class="ui left vertical menu sidebar">
    <a class="item" onclick="setTable('product')">
        Products
    </a>
    <a class="item" onclick="setTable('customer')">
        Customers
    </a>
    <a class="item" onclick="setTable('review')">
        Reviews
    </a>
</div>
<div class="ui top fixed menu">
    <button class="ui inverted secondary icon button" style="box-shadow:unset" onclick="$('.ui.sidebar').sidebar('toggle')">
        <i class="bars icon"></i>
    </button>
    <h1 class="ui header" style="margin-top:0.2rem">Akka HTTP/Streams Project Client <span id="status"></span></h1>
</div>
<div class="pusher" style="padding-top:4em">
    <div id="container"></div>
</div>

<div class="ui modal" id="addCustomerModal">
    <div class="header">Add Customer</div>
    <div class="content">
        <form class="ui form" id="customerForm">
            <div class="field">
                <label>ID</label>
                <input type="number" min="1" step="1" name="id" placeholder="ID" required>
            </div>
            <div class="field">
                <label>Name</label>
                <input type="text" name="name" placeholder="Name">
            </div>
            <button class="ui button" type="submit">Add</button>
        </form>
    </div>
</div>

<div class="ui modal" id="addProductModal">
    <div class="header">Add Product</div>
    <div class="content">
        <form class="ui form" id="productForm">
            <div class="field">
                <label>ID</label>
                <input type="text" name="id" placeholder="ID" required>
            </div>
            <div class="field">
                <label>Title</label>
                <input type="text" name="title" placeholder="Title" required>
            </div>
            <div class="field">
                <label>Category</label>
                <input type="text" name="category" placeholder="Category" required>
            </div>
            <button class="ui button" type="submit">Add</button>
        </form>
    </div>
</div>

<div class="ui modal" id="addReviewModal">
    <div class="header">Add Review</div>
    <div class="content">
        <form class="ui equal width form" id="reviewForm">
            <div class="field">
                <label>ID</label>
                <input type="text" name="id" placeholder="ID" required>
            </div>
            <div class="fields">
                <div class="field">
                    <label>Title</label>
                    <input type="text" name="title" placeholder="Title" required>
                </div>
                <div class="field">
                    <label>Rating</label>
                    <input type="number" min="0" max="5" step="1" name="rating" placeholder="5" required>
                </div>
                <div class="field">
                    <label>Date</label>
                    <input type="date"  name="date" placeholder="YYYY-MM-DD" required>
                </div>
                <div class="field">
                    <label>Region</label>
                    <input type="text" maxlength="2" name="region" placeholder="Region Code (US/EU/JP)" required>
                </div>
            </div>
            <div class="field">
                <label>Body</label>
                <input type="text"  name="body" placeholder="Body" required>
            </div>
            <div class="fields">
                <div class="field">
                    <label>Customer</label>
                    <input type="number" min="1" step="1" name="customer" placeholder="Customer ID" required>
                </div>
                <div class="field">
                    <label>Product</label>
                    <input type="text" name="product" placeholder="Product ID" required>
                </div>
            </div>
            <div class="fields">
            <div class="field">
                <label>Votes</label>
                <input type="number" min="0" step="1" value="0" name="votes" placeholder="Review Votes by other Customers" required>
            </div>
            <div class="field">
                <div class="ui checkbox" id="verifiedNew">
                    <input type="checkbox" tabindex="0" name="verified" class="hidden">
                    <label>Verified Purchase</label>
                </div>
            </div>
                <div class="field">
                    <label>Helpful</label>
                    <input type="number" min="0" max="5" step="1" value="0" name="helpful" placeholder="Review Helpfulness Votes" required>
                </div>
                <div class="field">
                    <div class="ui checkbox" id="vineNew">
                        <input type="checkbox" tabindex="0" name="vine" class="hidden">
                        <label>Part of the Vine program</label>
                    </div>
                </div>
            </div>
            <button class="ui button" type="submit">Add</button>
        </form>
    </div>
</div>
</body>

<div class="ui modal" id="viewCustomerModal">
    <div class="header">Customer Reviewed Products</div>
    <div class="scrolling content">
    </div>
</div>

<div class="ui modal" id="viewProductModal">
    <div class="header">Product Reviews</div>
    <div class="scrolling content">
    </div>
</div>
</html>